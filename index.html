<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>e621 Score Guessing Game</title>
    <style>
        body {
            font-family: Arial, sans-serif;
            background-color: #0a1421;
            color: #eee;
            margin: 0;
            padding: 20px;
            text-align: center;
            min-height: 100vh;
            position: relative;
        }
        h1 {
            color: #ffcc00;
            margin: 15px 0 10px;
            font-size: 2.6em;
        }
        #hud {
            font-size: 1.9em;
            margin: 10px 0 25px;
        }
        #score { color: #4caf50; }
        #coins { color: #ffd700; }
        #high-score {
            position: absolute;
            top: 20px;
            left: 20px;
            font-size: 1.4em;
            color: #ffcc00;
            background: rgba(0,0,0,0.5);
            padding: 8px 16px;
            border-radius: 8px;
            z-index: 20;
        }
        #game-container {
            max-width: 1250px;
            margin: 0 auto;
            width: 100%;
        }
        #game-area {
            display: flex;
            justify-content: center;
            gap: 90px;
            margin: 20px auto 120px; /* –±–æ–ª—å—à–µ –º–µ—Å—Ç–∞ —Å–Ω–∏–∑—É –¥–ª—è —Ä–µ–∑—É–ª—å—Ç–∞—Ç–∞ */
            width: 100%;
            min-height: 700px; /* —Ñ–∏–∫—Å–∏—Ä–æ–≤–∞–Ω–Ω–∞—è –≤—ã—Å–æ—Ç–∞ –∑–æ–Ω—ã –∫–∞—Ä—Ç–æ—á–µ–∫ */
        }
        .card-container {
            width: 520px;
            min-height: 700px; /* —Ñ–∏–∫—Å–∏—Ä–æ–≤–∞–Ω–Ω–∞—è –≤—ã—Å–æ—Ç–∞ –∫–æ–Ω—Ç–µ–π–Ω–µ—Ä–∞ –∫–∞—Ä—Ç–æ—á–∫–∏ */
            display: flex;
            flex-direction: column;
        }
        .card {
            width: 100%;
            min-height: 650px;
            background: #1a1a1a;
            border: 4px solid #444;
            border-radius: 20px;
            overflow: hidden;
            cursor: pointer;
            transition: all 0.8s ease;
            box-shadow: 0 6px 20px rgba(0,0,0,0.8);
            aspect-ratio: 3 / 4;
            display: flex;
            flex-direction: column;
        }
        .card:hover {
            transform: scale(1.03);
            border-color: #ffcc00;
        }
        .card img {
            width: 100%;
            height: auto;
            flex-grow: 1;
            object-fit: contain;
            background: #000;
        }
        .info {
            padding: 14px;
            font-size: 1.3em;
            text-align: center;
            background: rgba(0,0,0,0.75);
            display: none;
        }
        .revealed .info {
            display: block;
        }
        .dimmed {
            opacity: 0.55;
            filter: grayscale(60%);
        }
        .highlighted {
            transform: scale(1.10);
            box-shadow: 0 0 25px rgba(76, 175, 80, 0.6);
        }
        #message {
            font-size: 2.1em;
            margin: 15px 0 20px;
            min-height: 2.4em;
        }
        #result-message {
            font-size: 1.8em;
            margin: 20px 0;
            min-height: 60px;
            font-weight: bold;
        }
        #sidebar {
            position: fixed;
            top: 140px;
            right: 15px;
            width: 220px;
            display: flex;
            flex-direction: column;
            align-items: flex-end;
            gap: 16px;
            z-index: 10;
        }
        #powerups {
            display: flex;
            flex-direction: column;
            gap: 16px;
        }
        .powerup-btn {
            width: 180px;
            height: 80px;
            font-size: 1.1em;
            font-weight: bold;
            color: white;
            background: linear-gradient(135deg, #4a4a4a, #2a2a2a);
            border: 3px solid #777;
            border-radius: 16px;
            cursor: pointer;
            transition: all 0.3s ease;
            display: flex;
            flex-direction: column;
            align-items: center;
            justify-content: center;
            text-align: center;
            padding: 8px;
            box-shadow: 0 4px 15px rgba(0,0,0,0.6);
        }
        .powerup-btn:hover:not(:disabled) {
            transform: translateY(-4px) scale(1.05);
            border-color: #ffcc00;
            box-shadow: 0 8px 25px rgba(255, 204, 0, 0.4);
        }
        .powerup-btn:disabled {
            opacity: 0.35;
            cursor: not-allowed;
            transform: none;
            box-shadow: none;
        }
        .powerup-btn .cost {
            font-size: 0.95em;
            color: #ffcc00;
            margin-top: 4px;
        }
        #footer-fixed {
            position: fixed;
            bottom: 10px;
            right: 20px;
            font-size: 1.1em;
            color: #aaa;
            z-index: 5;
            pointer-events: none;
            background: rgba(10, 20, 33, 0.7);
            padding: 6px 14px;
            border-radius: 8px;
        }
        #footer-fixed a {
            color: #ffcc00;
            text-decoration: none;
            font-weight: bold;
        }
        #footer-fixed a:hover {
            text-decoration: underline;
        }
        /* Age warning overlay */
        #age-warning {
            position: fixed;
            inset: 0;
            background: rgba(0,0,0,0.92);
            z-index: 9999;
            display: flex;
            flex-direction: column;
            align-items: center;
            justify-content: center;
            padding: 30px;
            text-align: center;
        }
        #age-warning h2 {
            color: #ff4444;
            font-size: 2.8em;
            margin-bottom: 20px;
        }
        #age-warning p {
            font-size: 1.4em;
            max-width: 700px;
            margin: 0 auto 40px;
            line-height: 1.5;
        }
        .age-btn {
            padding: 18px 60px;
            font-size: 1.5em;
            margin: 15px;
            border: none;
            border-radius: 12px;
            cursor: pointer;
            transition: all 0.2s;
        }
        #confirm-18 {
            background: #28a745;
            color: white;
        }
        #confirm-18:hover {
            background: #218838;
        }
        #exit-under18 {
            background: #dc3545;
            color: white;
        }
        #exit-under18:hover {
            background: #c82333;
        }
    </style>
</head>
<body>

    <!-- Age verification overlay -->
    <div id="age-warning">
        <h2>18+ WARNING</h2>
        <p>
            This website contains explicit adult content.<br>
            By continuing you confirm that you are at least 18 years old<br>
        </p>
        <button id="confirm-18" class="age-btn">I'm older than 18</button>
        <button id="exit-under18" class="age-btn">I'm under 18</button>
    </div>

    <!-- Highest score -->
    <div id="high-score">Highest Score: 0</div>

    <div id="game-container">
        <main>
            <h1>e621 Score Guessing Game</h1>

            <div id="hud">
                <span id="score">Score: 0</span>  
                <span style="margin: 0 25px;">‚Ä¢</span>  
                <span id="coins">Coins: 0</span>
            </div>

            <div id="message">Which one has the higher score? Click to guess!</div>
            <div id="game-area">
                <div class="card-container">
                    <div class="card" id="card-left">
                        <div id="loading-left">Loading...</div>
                    </div>
                </div>
                <div class="card-container">
                    <div class="card" id="card-right">
                        <div id="loading-right">Loading...</div>
                    </div>
                </div>
            </div>

            <!-- –†–µ–∑—É–ª—å—Ç–∞—Ç –ø–æ—è–≤–ª—è–µ—Ç—Å—è –ø–æ–¥ –∫–∞—Ä—Ç–æ—á–∫–∞–º–∏ -->
            <div id="result-message"></div>

            <div id="sidebar">
                <div id="powerups">
                    <button class="powerup-btn" id="powerup-reveal-one" disabled>Reveal 1<br><span class="cost">5 ü™ô</span></button>
                    <button class="powerup-btn" id="powerup-reveal-both" disabled>Reveal Both<br><span class="cost">10 ü™ô</span></button>
                    <button class="powerup-btn" id="powerup-skip" disabled>Skip Pair<br><span class="cost">8 ü™ô</span></button>
                </div>
            </div>
        </main>
    </div>

    <!-- –§–∏–∫—Å–∏—Ä–æ–≤–∞–Ω–Ω—ã–π —Ñ—É—Ç–µ—Ä –≤ –ø—Ä–∞–≤–æ–º –Ω–∏–∂–Ω–µ–º —É–≥–ª—É -->
    <div id="footer-fixed">
        Developed by <a href="https://e621.net/users/YOUR_USER_ID_HERE" target="_blank">Kitsune</a>
    </div>

    <script>
        const API_BASE = 'https://e621.net/posts.json';
        const USER_AGENT = 'ScoreGuessGame/1.0 (by Kitsune on e621)';
        const MIN_SCORE = 1000;
        const INITIAL_FETCH = 8;
        const PREFETCH_COUNT = 4;
        const REVEAL_PAUSE_MS = 2500;

        const STORAGE_KEY_COINS = 'e621-guess-game-coins';
        const STORAGE_KEY_HIGH_SCORE = 'e621-guess-game-high-score';
        const STORAGE_KEY_AGE_CONFIRMED = 'e621-age-confirmed';

        // Age verification (–Ω–∞–≤—Å–µ–≥–¥–∞)
        const ageWarning = document.getElementById('age-warning');
        const gameContainer = document.getElementById('game-container');
        const confirm18 = document.getElementById('confirm-18');
        const exitUnder18 = document.getElementById('exit-under18');

        if (localStorage.getItem(STORAGE_KEY_AGE_CONFIRMED) === 'true') {
            ageWarning.style.display = 'none';
            gameContainer.style.display = 'block';
        } else {
            gameContainer.style.display = 'none';
        }

        confirm18.addEventListener('click', () => {
            localStorage.setItem(STORAGE_KEY_AGE_CONFIRMED, 'true');
            ageWarning.style.display = 'none';
            gameContainer.style.display = 'block';
            startGame();
        });

        exitUnder18.addEventListener('click', () => {
            window.close();
        });

        // Game logic
        let score = 0;
        let coins = parseInt(localStorage.getItem(STORAGE_KEY_COINS)) || 0;
        let highScore = parseInt(localStorage.getItem(STORAGE_KEY_HIGH_SCORE)) || 0;
        let currentStreak = 0;
        let currentPair = [];
        let postCache = [];
        let isLoadingNext = false;
        let hasChosen = false;

        const scoreEl = document.getElementById('score');
        const coinsEl = document.getElementById('coins');
        const highScoreEl = document.getElementById('high-score');
        const messageEl = document.getElementById('message');
        const resultMessageEl = document.getElementById('result-message');
        const gameArea = document.getElementById('game-area');

        const puRevealOne  = document.getElementById('powerup-reveal-one');
        const puRevealBoth = document.getElementById('powerup-reveal-both');
        const puSkip       = document.getElementById('powerup-skip');

        function saveData() {
            localStorage.setItem(STORAGE_KEY_COINS, coins);
            localStorage.setItem(STORAGE_KEY_HIGH_SCORE, highScore);
        }

        function updateUI() {
            scoreEl.textContent = `Score: ${score}`;
            coinsEl.textContent = `Coins: ${coins}`;
            highScoreEl.textContent = `Highest Score: ${highScore}`;
            puRevealOne.disabled  = coins < 5;
            puRevealBoth.disabled = coins < 10;
            puSkip.disabled       = coins < 8;
            saveData();
        }

        function checkHighScore() {
            if (score > highScore) {
                highScore = score;
                updateUI();
            }
        }

        async function fetchPosts(count = PREFETCH_COUNT) {
            const tags = `score:>${MIN_SCORE} order:random`;
            const url = `${API_BASE}?limit=${count}&tags=${encodeURIComponent(tags)}`;

            try {
                const res = await fetch(url, { headers: { 'User-Agent': USER_AGENT } });
                if (!res.ok) throw new Error(`API error: ${res.status}`);
                const data = await res.json();
                let posts = data.posts || [];

                posts = posts.filter(post => {
                    const ext = post.file?.ext?.toLowerCase() || '';
                    const rating = post.rating?.toLowerCase() || '';
                    return ['jpg','jpeg','png'].includes(ext) &&
                           post.preview?.url &&
                           post.score?.total >= MIN_SCORE &&
                           rating !== 's';
                });

                return posts;
            } catch (err) {
                console.error(err);
                messageEl.textContent = `Error fetching: ${err.message}`;
                return [];
            }
        }

        async function prefetchMore() {
            if (postCache.length < 6 && !isLoadingNext) {
                isLoadingNext = true;
                const newPosts = await fetchPosts(PREFETCH_COUNT);
                postCache.push(...newPosts);
                isLoadingNext = false;
            }
        }

        async function getNextPair() {
            while (postCache.length < 2) {
                messageEl.textContent = 'Loading more images...';
                await prefetchMore();
                if (postCache.length === 0) return [];
            }

            let a = postCache.shift();
            let b = postCache.shift();

            if (a.id === b.id && postCache.length >= 1) {
                b = postCache.shift();
            }

            prefetchMore();
            return [a, b];
        }

        function getImageUrl(post) {
            return post.preview?.url || '';
        }

        function createCard(post, index) {
            const div = document.createElement('div');
            div.className = 'card';
            div.dataset.index = index;
            div.style.borderColor = '#444';

            const img = document.createElement('img');
            img.src = getImageUrl(post);
            img.alt = `Post ${post.id}`;
            img.loading = 'lazy';

            const info = document.createElement('div');
            info.className = 'info';

            div.appendChild(img);
            div.appendChild(info);

            div.addEventListener('click', () => handleGuess(index));

            return div;
        }

        function showPair(pair) {
            // –ü–æ–ª–Ω–æ—Å—Ç—å—é –æ—á–∏—â–∞–µ–º —Å—Ç–∞—Ä—ã–µ –∫–∞—Ä—Ç–æ—á–∫–∏
            gameArea.innerHTML = '';

            currentPair = pair;

            pair.forEach((post, i) => {
                const container = document.createElement('div');
                container.className = 'card-container';
                container.appendChild(createCard(post, i));
                gameArea.appendChild(container);
            });

            // –ò–Ω—Å—Ç—Ä—É–∫—Ü–∏—è –ø–æ–∫–∞–∑—ã–≤–∞–µ—Ç—Å—è —Ç–æ–ª—å–∫–æ –¥–æ –ø–µ—Ä–≤–æ–≥–æ –≤—ã–±–æ—Ä–∞
            if (!hasChosen) {
                messageEl.textContent = 'Which one has the higher score? Click to guess!';
                messageEl.style.color = '#eee';
            } else {
                messageEl.style.display = 'none';
            }

            resultMessageEl.textContent = ''; // –æ—á–∏—â–∞–µ–º —Ä–µ–∑—É–ª—å—Ç–∞—Ç –æ—Ç –ø—Ä–µ–¥—ã–¥—É—â–µ–≥–æ —Ä–∞—É–Ω–¥–∞
        }

        function revealScores(indices = [0, 1]) {
            currentPair.forEach((post, i) => {
                if (indices.includes(i)) {
                    const container = gameArea.children[i];
                    const card = container.querySelector('.card');
                    card.classList.add('revealed');
                    const info = card.querySelector('.info');
                    const artist = post.tags?.artist?.[0] || 'Unknown';
                    info.innerHTML = `
                        <strong>Score: ${post.score.total}</strong><br>
                        Artist: ${artist}<br>
                        Rating: ${post.rating?.toUpperCase() || '?'} ‚Ä¢ ID: ${post.id}
                    `;
                }
            });
        }

        function handleGuess(clickedIndex) {
            if (currentPair.length !== 2) return;

            // –ü–æ—Å–ª–µ –ø–µ—Ä–≤–æ–≥–æ –≤—ã–±–æ—Ä–∞ —Å–∫—Ä—ã–≤–∞–µ–º –∏–Ω—Å—Ç—Ä—É–∫—Ü–∏—é
            if (!hasChosen) {
                hasChosen = true;
                messageEl.style.display = 'none';
            }

            const left = currentPair[0];
            const right = currentPair[1];
            const higherIndex = left.score.total > right.score.total ? 0 : 1;
            const won = clickedIndex === higherIndex;

            // –ü–æ–∫–∞–∑—ã–≤–∞–µ–º —Ä–µ–∑—É–ª—å—Ç–∞—Ç –ü–û–î –∫–∞—Ä—Ç–æ—á–∫–∞–º–∏
            if (won) {
                score += 1;
                currentStreak += 1;
                resultMessageEl.textContent = 'Correct! +1 point';
                resultMessageEl.style.color = '#4caf50';
                checkHighScore();
            } else {
                coins += currentStreak;
                resultMessageEl.innerHTML = `Wrong! Score reset<br>+${currentStreak} coins awarded`;
                resultMessageEl.style.color = '#f44336';
                currentStreak = 0;
                score = 0;
            }

            updateUI();
            revealScores([0, 1]);

            const higherContainer = gameArea.children[higherIndex];
            const lowerContainer = gameArea.children[1 - higherIndex];
            const higherCard = higherContainer.querySelector('.card');
            const lowerCard = lowerContainer.querySelector('.card');

            higherCard.classList.add('highlighted');
            lowerCard.classList.add('dimmed');

            higherCard.style.borderColor = '#4caf50';
            lowerCard.style.borderColor = '#f44336';

            currentPair = [];

            setTimeout(async () => {
                higherCard.classList.remove('highlighted');
                lowerCard.classList.remove('dimmed');

                resultMessageEl.textContent = ''; // –æ—á–∏—â–∞–µ–º —Ä–µ–∑—É–ª—å—Ç–∞—Ç –ø–µ—Ä–µ–¥ –Ω–æ–≤–æ–π –ø–∞—Ä–æ–π

                const nextPair = await getNextPair();
                if (nextPair.length === 2) {
                    if (Math.random() < 0.5) nextPair.reverse();
                    showPair(nextPair);
                } else {
                    resultMessageEl.innerHTML = 'No more images available<br>Refresh to play again';
                    gameArea.innerHTML = '<div id="loading">No images left</div>';
                }
            }, REVEAL_PAUSE_MS);
        }

        puRevealOne.onclick = () => {
            if (coins < 5 || currentPair.length !== 2) return;
            coins -= 5;
            updateUI();
            const rand = Math.random() < 0.5 ? 0 : 1;
            revealScores([rand]);
            resultMessageEl.textContent = 'Revealed one score';
            resultMessageEl.style.color = '#ffcc00';
        };

        puRevealBoth.onclick = () => {
            if (coins < 10 || currentPair.length !== 2) return;
            coins -= 10;
            updateUI();
            revealScores([0, 1]);
            resultMessageEl.textContent = 'Revealed both scores';
            resultMessageEl.style.color = '#ffcc00';
        };

        puSkip.onclick = () => {
            if (coins < 8 || currentPair.length !== 2) return;
            coins -= 8;
            updateUI();
            resultMessageEl.textContent = 'Pair skipped ‚Üí loading new...';
            resultMessageEl.style.color = '#ffcc00';
            setTimeout(async () => {
                const nextPair = await getNextPair();
                if (nextPair.length === 2) {
                    if (Math.random() < 0.5) nextPair.reverse();
                    showPair(nextPair);
                }
            }, 900);
        };

        async function startGame() {
            score = 0;
            currentStreak = 0;
            postCache = [];
            hasChosen = false;
            messageEl.style.display = 'block';
            resultMessageEl.textContent = '';
            updateUI();
            messageEl.textContent = 'Fetching initial images...';
            gameArea.innerHTML = '<div class="card-container"><div class="card"><div id="loading">Loading...</div></div></div><div class="card-container"><div class="card"><div id="loading">Loading...</div></div></div>';

            const initialPosts = await fetchPosts(INITIAL_FETCH);
            postCache.push(...initialPosts);

            const firstPair = await getNextPair();
            if (firstPair.length === 2) {
                if (Math.random() < 0.5) firstPair.reverse();
                showPair(firstPair);
                prefetchMore();
            } else {
                messageEl.textContent = 'Not enough valid posts ‚Äî try again later';
            }
        }

        // Initial start after age confirmation
        if (localStorage.getItem(STORAGE_KEY_AGE_CONFIRMED) === 'true') {
            startGame();
        }

        // –ü–æ–∫–∞–∑—ã–≤–∞–µ–º —Ä–µ–∫–æ—Ä–¥ –ø—Ä–∏ –∑–∞–≥—Ä—É–∑–∫–µ
        document.addEventListener('DOMContentLoaded', () => {
            highScoreEl.textContent = `Highest Score: ${highScore}`;
        });
    </script>
</body>
</html>
